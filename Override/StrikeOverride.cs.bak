using Microsoft.Xna.Framework;
using System.Reflection;
using Terraria;
using Terraria.Audio;
using Terraria.ID;
using Terraria.ModLoader;

namespace NPCAttacker
{
    public class StrikeOverride
    {
        public static double StrikeNPCHook(On.Terraria.NPC.orig_StrikeNPC orig, NPC Npc, int Damage, float knockBack, int hitDirection, bool crit = false, bool noEffect = false, bool fromNet = false)
        {

            if (!Npc.IsTownNPC())
            {
                return orig.Invoke(Npc, Damage, knockBack, hitDirection, crit, noEffect, fromNet);
            }
            else
            {
                if (Npc.GetGlobalNPC<ArmedGNPC>().actMode == ArmedGNPC.ActMode.Default)
                {
                    return orig.Invoke(Npc, Damage, knockBack, hitDirection, crit, noEffect, fromNet);
                }
            }
            bool flag = Main.netMode == NetmodeID.SinglePlayer;
            var ReflectTarget = typeof(NPC).GetField("ignorePlayerInteractions", BindingFlags.NonPublic | BindingFlags.Static);
            if (flag && (int)ReflectTarget.GetValue(new NPC()) > 0)
            {
                ReflectTarget.SetValue(new NPC(), (int)ReflectTarget.GetValue(new NPC()) - 1);
                flag = false;
            }
            if (!Npc.active || Npc.life <= 0)
            {
                return 0.0;
            }
            double num = Damage;
            int num2 = Npc.defense;
            if (Npc.ichor)
            {
                num2 -= 15;
            }
            if (Npc.betsysCurse)
            {
                num2 -= 40;
            }
            if (num2 < 0)
            {
                num2 = 0;
            }
            if (NPCLoader.StrikeNPC(Npc, ref num, num2, ref knockBack, hitDirection, ref crit))
            {
                num = Main.CalculateDamageNPCsTake((int)num, num2);
                if (crit)
                {
                    num *= 2.0;
                }
                if (Npc.takenDamageMultiplier > 1f)
                {
                    num *= Npc.takenDamageMultiplier;
                }
            }
            if ((Npc.takenDamageMultiplier > 1f || Damage != 9999) && Npc.lifeMax > 1)
            {
                if (Npc.friendly)
                {
                    Color color = crit ? CombatText.DamagedFriendlyCrit : CombatText.DamagedFriendly;
                    CombatText.NewText(new Rectangle((int)Npc.position.X, (int)Npc.position.Y, Npc.width, Npc.height), color, (int)num, crit, false);
                }
                else
                {
                    Color color2 = crit ? CombatText.DamagedHostileCrit : CombatText.DamagedHostile;
                    if (fromNet)
                    {
                        color2 = (crit ? CombatText.OthersDamagedHostileCrit : CombatText.OthersDamagedHostile);
                    }
                    CombatText.NewText(new Rectangle((int)Npc.position.X, (int)Npc.position.Y, Npc.width, Npc.height), color2, (int)num, crit, false);
                }
            }
            if (num >= 1.0)
            {
                if (flag)
                {
                    Npc.PlayerInteraction(Main.myPlayer);
                }
                Npc.justHit = true;
                if ((Npc.type == NPCID.CultistDevote || Npc.type == NPCID.CultistArcherBlue) && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int num3 = (int)(0f - Npc.ai[3] - 1f);
                    if (num3 > -1 && Main.npc[num3].localAI[0] == 0f)
                    {
                        Main.npc[num3].localAI[0] = 1f;
                    }
                }

                if (!NPCUtils.BuffNPC())
                {
                    if (Npc.townNPC)
                    {
                        if (Npc.aiStyle == 7 && (Npc.ai[0] == 3f || Npc.ai[0] == 4f || Npc.ai[0] == 16f || Npc.ai[0] == 17f))
                        {
                            NPC npc = Main.npc[(int)Npc.ai[2]];
                            if (npc.active)
                            {
                                npc.ai[0] = 1f;
                                npc.ai[1] = 300 + Main.rand.Next(300);
                                npc.ai[2] = 0f;
                                npc.localAI[3] = 0f;
                                npc.direction = hitDirection;
                                npc.netUpdate = true;
                            }
                        }
                        Npc.ai[0] = 1f;
                        Npc.ai[1] = 300 + Main.rand.Next(300);
                        Npc.ai[2] = 0f;
                        Npc.localAI[3] = 0f;
                        Npc.direction = hitDirection;
                        Npc.netUpdate = true;
                    }
                }

                if (Npc.IsTownNPC())
                {
                    if (Npc.GetGlobalNPC<ArmedGNPC>().actMode == ArmedGNPC.ActMode.Attack)
                    {
                        if (NPCID.Sets.AttackType[Npc.type] == 3)
                        {
                            knockBack = 0;
                        }
                    }

                    if (Npc.HasBuff(BuffID.Invisibility))   //ÒþÉíÒ©Ë®
                    {
                        knockBack = 0;
                    }

                    if (NPC.downedMoonlord)
                    {
                        knockBack *= 0.25f;
                    }
                    else if (Main.hardMode)
                    {
                        knockBack *= 0.5f;
                    }
                }
                if (Npc.aiStyle == 8 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    if (Npc.type == NPCID.RuneWizard)
                    {
                        Npc.ai[0] = 450f;
                    }
                    else if (Npc.type == NPCID.Necromancer || Npc.type == NPCID.NecromancerArmored)
                    {
                        if (Main.rand.NextBool(2))
                        {
                            Npc.ai[0] = 390f;
                            Npc.netUpdate = true;
                        }
                    }
                    else if (Npc.type == NPCID.DesertDjinn)
                    {
                        if (!Main.rand.NextBool(3))
                        {
                            Npc.ai[0] = 181f;
                            Npc.netUpdate = true;
                        }
                    }
                    else
                    {
                        Npc.ai[0] = 400f;
                    }
                    Npc.TargetClosest(true);
                }
                if (Npc.aiStyle == 97 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    Npc.localAI[1] = 1f;
                    Npc.TargetClosest(true);
                }
                if (Npc.type == NPCID.DetonatingBubble)
                {
                    num = 0.0;
                    Npc.ai[0] = 1f;
                    Npc.ai[1] = 4f;
                    Npc.dontTakeDamage = true;
                }
                if (Npc.type == NPCID.SantaNK1 && Npc.life >= Npc.lifeMax * 0.5 && Npc.life - num < Npc.lifeMax * 0.5)
                {
                    Gore.NewGore(null, Npc.position, Npc.velocity, 517, 1f);
                }
                if (Npc.type == NPCID.SpikedIceSlime)
                {
                    Npc.localAI[0] = 60f;
                }
                if (Npc.type == NPCID.SlimeSpiked)
                {
                    Npc.localAI[0] = 60f;
                }
                if (Npc.type == NPCID.SnowFlinx)
                {
                    Npc.localAI[0] = 1f;
                }
                if (!Npc.immortal)
                {
                    if (Npc.realLife >= 0)
                    {
                        Main.npc[Npc.realLife].life -= (int)num;
                        Npc.life = Main.npc[Npc.realLife].life;
                        Npc.lifeMax = Main.npc[Npc.realLife].lifeMax;
                    }
                    else
                    {
                        Npc.life -= (int)num;
                    }
                }
                if (knockBack > 0f && Npc.knockBackResist > 0f)
                {
                    float num4 = knockBack * Npc.knockBackResist;
                    if (Npc.onFire2)
                    {
                        num4 *= 1.1f;
                    }
                    if (num4 > 8f)
                    {
                        float num5 = num4 - 8f;
                        num5 *= 0.9f;
                        num4 = 8f + num5;
                    }
                    if (num4 > 10f)
                    {
                        float num6 = num4 - 10f;
                        num6 *= 0.8f;
                        num4 = 10f + num6;
                    }
                    if (num4 > 12f)
                    {
                        float num7 = num4 - 12f;
                        num7 *= 0.7f;
                        num4 = 12f + num7;
                    }
                    if (num4 > 14f)
                    {
                        float num8 = num4 - 14f;
                        num8 *= 0.6f;
                        num4 = 14f + num8;
                    }
                    if (num4 > 16f)
                    {
                        num4 = 16f;
                    }
                    if (crit)
                    {
                        num4 *= 1.4f;
                    }
                    int num9 = (int)num * 10;
                    if (Main.expertMode)
                    {
                        num9 = (int)num * 15;
                    }
                    if (num9 > Npc.lifeMax)
                    {
                        if (hitDirection < 0 && Npc.velocity.X > 0f - num4)
                        {
                            if (Npc.velocity.X > 0f)
                            {
                                Npc.velocity.X = Npc.velocity.X - num4;
                            }
                            Npc.velocity.X = Npc.velocity.X - num4;
                            if (Npc.velocity.X < 0f - num4)
                            {
                                Npc.velocity.X = 0f - num4;
                            }
                        }
                        else if (hitDirection > 0 && Npc.velocity.X < num4)
                        {
                            if (Npc.velocity.X < 0f)
                            {
                                Npc.velocity.X = Npc.velocity.X + num4;
                            }
                            Npc.velocity.X = Npc.velocity.X + num4;
                            if (Npc.velocity.X > num4)
                            {
                                Npc.velocity.X = num4;
                            }
                        }
                        if (Npc.type == NPCID.SnowFlinx)
                        {
                            num4 *= 1.5f;
                        }
                        num4 = (Npc.noGravity ? (num4 * -0.5f) : (num4 * -0.75f));
                        if (Npc.velocity.Y > num4)
                        {
                            Npc.velocity.Y = Npc.velocity.Y + num4;
                            if (Npc.velocity.Y < num4)
                            {
                                Npc.velocity.Y = num4;
                            }
                        }
                    }
                    else
                    {
                        if (!Npc.noGravity)
                        {
                            Npc.velocity.Y = (0f - num4) * 0.75f * Npc.knockBackResist;
                        }
                        else
                        {
                            Npc.velocity.Y = (0f - num4) * 0.5f * Npc.knockBackResist;
                        }
                        Npc.velocity.X = num4 * hitDirection * Npc.knockBackResist;
                    }
                }
                if ((Npc.type == NPCID.WallofFlesh || Npc.type == NPCID.WallofFleshEye) && Npc.life <= 0)
                {
                    for (int i = 0; i < 200; i++)
                    {
                        if (Main.npc[i].active && (Main.npc[i].type == NPCID.WallofFlesh || Main.npc[i].type == NPCID.WallofFleshEye))
                        {
                            Main.npc[i].HitEffect(hitDirection, num);
                        }
                    }
                }
                else
                {
                    Npc.HitEffect(hitDirection, num);
                }
                if (Npc.HitSound != null)
                {
                    SoundEngine.PlaySound(Npc.HitSound, new Vector2?(Npc.position));
                }
                if (Npc.realLife >= 0)
                {
                    Main.npc[Npc.realLife].checkDead();
                }
                else
                {
                    Npc.checkDead();
                }
                return num;
            }
            return 0.0;
        }
    }
}